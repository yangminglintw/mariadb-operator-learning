# MariaDB Operator CRDs 101

## Overview

MariaDB Operator manages multiple Custom Resource Definitions (CRDs). This document explains each CRD and how they relate to each other.

## CRD Map

```
                          MariaDB Operator
┌─────────────────────────────────────────────────────────────────────────┐
│                                                                         │
│  Core Resources                                                         │
│  ┌─────────────┐      ┌─────────────┐      ┌─────────────┐             │
│  │  MariaDB    │      │  MaxScale   │      │   Galera    │             │
│  │  (Database) │      │  (Proxy)    │      │  (Cluster)  │             │
│  └──────┬──────┘      └─────────────┘      └─────────────┘             │
│         │                                                               │
│         │ mariaDbRef                                                    │
│         ▼                                                               │
│  SQL Resources (require mariaDbRef)                                     │
│  ┌─────────────┐      ┌─────────────┐      ┌─────────────┐             │
│  │  Database   │      │    User     │      │    Grant    │             │
│  │  (Schema)   │      │  (Account)  │      │ (Privilege) │             │
│  └─────────────┘      └─────────────┘      └─────────────┘             │
│                                                                         │
│  Job Resources                                                          │
│  ┌─────────────┐      ┌─────────────┐      ┌─────────────┐             │
│  │   Backup    │      │   Restore   │      │   SqlJob    │             │
│  │  (Export)   │      │  (Import)   │      │  (Script)   │             │
│  └─────────────┘      └─────────────┘      └─────────────┘             │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 1. Database CR

Creates a logical database (schema) in MariaDB.

**Equivalent SQL**: `CREATE DATABASE`

```yaml
apiVersion: k8s.mariadb.com/v1alpha1
kind: Database
metadata:
  name: myapp-db
spec:
  mariaDbRef:
    name: mariadb          # Which MariaDB instance
  characterSet: utf8       # Character set
  collate: utf8_general_ci # Collation
  cleanupPolicy: Delete    # Delete DB when CR is deleted
```

**Generated SQL**:
```sql
CREATE DATABASE `myapp-db`
  CHARACTER SET utf8
  COLLATE utf8_general_ci;
```

**Key Fields**:
| Field | Description | Default |
|-------|-------------|---------|
| `mariaDbRef` | Reference to MariaDB instance | Required |
| `characterSet` | Character encoding | `utf8` |
| `collate` | Sorting rules | `utf8_general_ci` |
| `cleanupPolicy` | What happens on CR deletion | - |

---

## 2. User CR

Creates a MariaDB user account.

**Equivalent SQL**: `CREATE USER`

```yaml
apiVersion: k8s.mariadb.com/v1alpha1
kind: User
metadata:
  name: myapp-user
spec:
  mariaDbRef:
    name: mariadb
  passwordSecretKeyRef:
    name: myapp-secret     # Secret containing password
    key: password
  maxUserConnections: 20   # Max simultaneous connections
  host: "%"                # Where can connect from (% = anywhere)
  cleanupPolicy: Delete
```

**Generated SQL**:
```sql
CREATE USER 'myapp-user'@'%'
  IDENTIFIED BY 'xxx'
  WITH MAX_USER_CONNECTIONS 20;
```

**Key Fields**:
| Field | Description | Default |
|-------|-------------|---------|
| `mariaDbRef` | Reference to MariaDB instance | Required |
| `passwordSecretKeyRef` | Reference to password Secret | Required |
| `maxUserConnections` | Max connections for this user | `10` |
| `host` | Allowed connection source | `%` |

**Note**: Issue #922 changes `maxUserConnections` to be nullable, allowing server defaults.

---

## 3. Grant CR

Grants privileges to a user.

**Equivalent SQL**: `GRANT`

```yaml
apiVersion: k8s.mariadb.com/v1alpha1
kind: Grant
metadata:
  name: myapp-grant
spec:
  mariaDbRef:
    name: mariadb
  privileges:              # Privileges to grant
    - "SELECT"
    - "INSERT"
    - "UPDATE"
  database: "myapp-db"     # On which database
  table: "*"               # On which tables
  username: myapp-user     # To which user
  host: "%"
  grantOption: true        # Can re-grant to others
  cleanupPolicy: Delete
```

**Generated SQL**:
```sql
GRANT SELECT, INSERT, UPDATE
  ON `myapp-db`.*
  TO 'myapp-user'@'%'
  WITH GRANT OPTION;
```

**Key Fields**:
| Field | Description | Default |
|-------|-------------|---------|
| `privileges` | List of privileges | Required |
| `database` | Target database | `*` |
| `table` | Target table(s) | `*` |
| `username` | Target user | Required |
| `grantOption` | Allow re-granting | `false` |

---

## 4. Backup CR

Creates backup jobs (one-time or scheduled).

```yaml
apiVersion: k8s.mariadb.com/v1alpha1
kind: Backup
metadata:
  name: daily-backup
spec:
  mariaDbRef:
    name: mariadb
  compression: gzip        # none, bzip2, gzip
  storage:                 # Where to store backups
    persistentVolumeClaim:
      resources:
        requests:
          storage: 100Mi
  schedule:                # Optional: make it recurring
    cron: "0 2 * * *"     # Every day at 2 AM
  maxRetention: 720h       # Keep backups for 30 days
```

**Features**:
- Creates CronJob (scheduled) or Job (one-time)
- Runs `mariadb-dump` internally
- Supports S3, PVC, NFS storage
- Auto-cleanup old backups via `maxRetention`

**Key Fields**:
| Field | Description | Default |
|-------|-------------|---------|
| `compression` | Compression algorithm | `none` |
| `storage` | Backup destination | Required |
| `schedule` | Cron schedule for recurring backups | - |
| `maxRetention` | How long to keep backups | `720h` (30 days) |

---

## 5. Restore CR

Restores data from a backup.

```yaml
apiVersion: k8s.mariadb.com/v1alpha1
kind: Restore
metadata:
  name: restore-from-backup
spec:
  mariaDbRef:
    name: mariadb
  backupRef:
    name: daily-backup    # Reference to Backup CR
  # Or specify S3/Volume directly
```

**Key Fields**:
| Field | Description |
|-------|-------------|
| `backupRef` | Reference to Backup CR |
| `s3` | Direct S3 source |
| `volume` | Direct volume source |
| `targetRecoveryTime` | Point-in-time recovery target |

---

## 6. SqlJob CR

Executes SQL scripts.

```yaml
apiVersion: k8s.mariadb.com/v1alpha1
kind: SqlJob
metadata:
  name: init-data
spec:
  mariaDbRef:
    name: mariadb
  sql: |
    INSERT INTO users (name) VALUES ('admin');
  # Or reference a ConfigMap
  sqlConfigMapKeyRef:
    name: init-script
    key: init.sql
```

---

## Relationships Between CRDs

```
                    ┌─────────────┐
                    │   MariaDB   │
                    └──────┬──────┘
                           │
           ┌───────────────┼───────────────┐
           │               │               │
           ▼               ▼               ▼
    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
    │  Database   │ │    User     │ │   Backup    │
    │  myapp-db   │ │ myapp-user  │ │   daily     │
    └─────────────┘ └──────┬──────┘ └──────┬──────┘
                           │               │
                           ▼               ▼
                    ┌─────────────┐ ┌─────────────┐
                    │    Grant    │ │   Restore   │
                    │ myapp-grant │ │  restore-1  │
                    └─────────────┘ └─────────────┘
```

**Important**: All SQL-related CRs require `mariaDbRef` to specify which MariaDB instance to operate on.

---

## Complete Example: Deploy an Application

```yaml
# 1. MariaDB instance
apiVersion: k8s.mariadb.com/v1alpha1
kind: MariaDB
metadata:
  name: myapp-mariadb
spec:
  rootPasswordSecretKeyRef:
    name: mariadb-root
    key: password
  storage:
    size: 10Gi
---
# 2. Create database
apiVersion: k8s.mariadb.com/v1alpha1
kind: Database
metadata:
  name: myapp-db
spec:
  mariaDbRef:
    name: myapp-mariadb
---
# 3. Create user
apiVersion: k8s.mariadb.com/v1alpha1
kind: User
metadata:
  name: myapp-user
spec:
  mariaDbRef:
    name: myapp-mariadb
  passwordSecretKeyRef:
    name: myapp-password
    key: password
---
# 4. Grant privileges
apiVersion: k8s.mariadb.com/v1alpha1
kind: Grant
metadata:
  name: myapp-grant
spec:
  mariaDbRef:
    name: myapp-mariadb
  privileges:
    - "ALL PRIVILEGES"
  database: "myapp-db"
  table: "*"
  username: myapp-user
---
# 5. Daily backup
apiVersion: k8s.mariadb.com/v1alpha1
kind: Backup
metadata:
  name: myapp-backup
spec:
  mariaDbRef:
    name: myapp-mariadb
  schedule:
    cron: "0 2 * * *"
  storage:
    persistentVolumeClaim:
      resources:
        requests:
          storage: 1Gi
```

---

## Quick Reference: kubectl Short Names

| CRD | Short Name | Example |
|-----|------------|---------|
| MariaDB | `mdb` | `kubectl get mdb` |
| Database | `dmdb` | `kubectl get dmdb` |
| User | `umdb` | `kubectl get umdb` |
| Grant | `gmdb` | `kubectl get gmdb` |
| Backup | `bmdb` | `kubectl get bmdb` |
| Restore | `rmdb` | `kubectl get rmdb` |

---

## Key Takeaways

1. **All SQL CRs need `mariaDbRef`** - They must reference a MariaDB instance
2. **Declarative management** - Define desired state, operator handles reconciliation
3. **cleanupPolicy** - Controls what happens when CR is deleted (`Delete` or `Skip`)
4. **Secrets for passwords** - Never put passwords directly in YAML
5. **Operator creates K8s resources** - StatefulSets, Services, Jobs, CronJobs, etc.
